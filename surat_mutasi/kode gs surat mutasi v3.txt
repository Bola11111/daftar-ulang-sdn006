var SS_ID = "1X4PN2IyBQR-HLl7kQyZ8OHg4WvnkqUQYVyZEU5KOirE"; 
var FOLDER_ID = "1FtP9q4A-CmKspG05i35y-SDvKmvCrm-lsuU49ir4czdE3-VVL3sptS5RfC48p6dCU49qP2Sz";
var TEMPLATE_ID = "1UKd8DYjV07OaNq8-lqF0rSozO8WxMXRUk0xmdUf5zVU"; 

function doGet(e) {
  var action = e.parameter.action;
  if (action === "getSiswa") {
    var sheet = SpreadsheetApp.openById(SS_ID).getSheetByName("database");
    var data = sheet.getDataRange().getDisplayValues(); 
    var dataSiswa = data.slice(1).map(function(r) {
      return { kelas: r[1], nama: r[2], jk: r[3], nisn: r[4], tempatLahir: r[7], tanggalLahir: r[8] };
    });
    return ContentService.createTextOutput(JSON.stringify(dataSiswa)).setMimeType(ContentService.MimeType.JSON);
  }
  return HtmlService.createTemplateFromFile('Index').evaluate().setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var obj = data.obj;
    var fileData = data.fileData;
    var ss = SpreadsheetApp.openById(SS_ID);
    var sheetMutasi = ss.getSheetByName("mutasi");
    var folder = DriveApp.getFolderById(FOLDER_ID);

    // --- 1. OLAH TANGGAL UNTUK LABEL NAMA FILE (dd-mm-yy) ---
    var tglSplit = obj.tanggalMutasi.split("-"); // Dari yyyy-mm-dd
    var tglLabel = tglSplit[2] + "-" + tglSplit[1] + "-" + tglSplit[0].substring(2); // Hasil: 10-01-26
    
    // --- 2. UPLOAD BUKTI DENGAN NAMA: BUKTI_NAMA_TANGGAL ---
    var fileUrl = "-";
    if (fileData) {
      var namaFileBukti = "BUKTI_" + obj.nama.toUpperCase() + "_" + tglLabel;
      var blobBukti = Utilities.newBlob(Utilities.base64Decode(fileData.data), fileData.type, namaFileBukti);
      fileUrl = folder.createFile(blobBukti).getUrl();
    }

    // --- 3. INPUT DATA KE SHEET MUTASI ---
    sheetMutasi.appendRow([
      new Date(), obj.kelas, obj.nama, obj.jk, obj.nisn, obj.tempatLahir, obj.tanggalLahir, 
      obj.sekolahTujuan, obj.npsn, obj.alamat, obj.kelurahan, obj.kecamatan, obj.kota, obj.provinsi,
      "Mutasi", obj.tanggalMutasi, fileUrl 
    ]);

    // Paksa hitung rumus di Sheet agar Kolom R terisi
    SpreadsheetApp.flush(); 
    Utilities.sleep(1000);
    
    var lastRow = sheetMutasi.getLastRow();
    var tanggalIndo = sheetMutasi.getRange(lastRow, 18).getDisplayValue(); // Ambil dari Kolom R

    // --- 4. BUAT DOC DENGAN NAMA: SURAT_MUTASI_NAMA_TANGGAL ---
    var namaDocBaru = "SURAT_MUTASI_" + obj.nama.toUpperCase() + "_" + tglLabel;
    var copyFile = DriveApp.getFileById(TEMPLATE_ID).makeCopy(namaDocBaru, folder);
    var docUrl = copyFile.getUrl();
    
    // Simpan link Doc ke Kolom S (19)
    sheetMutasi.getRange(lastRow, 19).setValue(docUrl);

    // Isi data ke dalam Document
    var doc = DocumentApp.openById(copyFile.getId());
    var body = doc.getBody();
	
    body.replaceText("<<Nama>>", obj.nama);
    body.replaceText("<<NISN>>", obj.nisn);
    body.replaceText("<<jk>>", obj.jk);
    body.replaceText("<<Tempat>>", obj.tempatLahir);
    body.replaceText("<<Tanggal Lahir>>", obj.tanggalLahir);
    body.replaceText("<<Kelas>>", obj.kelas);
    body.replaceText("<<SD Tujuan>>", obj.sekolahTujuan);
    body.replaceText("<<NPSN>>", obj.npsn);
    body.replaceText("<<Kelurahan>>", obj.kelurahan);
    body.replaceText("<<Kecamatan>>", obj.kecamatan);
    body.replaceText("<<Kota>>", obj.kota);
    body.replaceText("<<Provinsi>>", obj.provinsi);
    body.replaceText("<<mutasi>>", "Mutasi");
    body.replaceText("<<tanggal mutasi>>", tanggalIndo);
    
    doc.saveAndClose();

    return ContentService.createTextOutput(JSON.stringify({"status": "Sukses", "nama": obj.nama})).setMimeType(ContentService.MimeType.JSON);
    
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({"status": "Error", "message": err.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

function cekAksesNISN(n) { return; }
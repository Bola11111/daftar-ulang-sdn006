<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Layanan Mutasi - SDN 006 Sungai Pinang</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background-color: #f4f7fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
    .blue-header { 
      background: #1a237e; color: white; padding: 25px 10px; text-align: center; 
      font-weight: 800; font-size: 1.8rem; letter-spacing: 5px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; text-transform: uppercase; 
    }
    .main-card { max-width: 600px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden; }
    .section-divider { border-left: 5px solid #1a237e; padding-left: 15px; margin: 30px 20px 15px 20px; font-weight: 700; color: #1a237e; text-transform: uppercase; font-size: 0.9rem; }
    .readonly-field { background-color: #f8f9fa !important; border: 1px solid #dee2e6 !important; font-weight: 600; color: #555; }
    label { font-size: 0.85rem; font-weight: 700; color: #333; margin-bottom: 5px; display: block; padding-left: 20px; }
    .form-group { margin-bottom: 1.2rem; }
    .form-control, .form-select { width: calc(100% - 40px); margin: 0 20px; border-radius: 8px; }
    .btn-submit { margin: 20px; width: calc(100% - 40px); padding: 15px; font-weight: 700; border-radius: 8px; transition: 0.3s; }
    .hidden { display: none; }
    @media (max-width: 576px) { .blue-header { font-size: 1rem; letter-spacing: 2px; } .main-card { margin: 10px; } }
    
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; visibility: hidden; }
  </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-primary"></div><span class="ms-2 fw-bold">Sedang memuat data...</span></div>

<div class="blue-header">SD NEGERI 006 SUNGAI PINANG</div>

<div class="container">
  <div id="home-section" class="text-center p-5 bg-white rounded-3 shadow-sm mx-auto mt-4" style="max-width: 700px;">
  <i class="bi bi-file-earmark-lock2-fill text-primary" style="font-size: 4rem;"></i>
  <h4 class="fw-bold mt-3">Layanan Mutasi Siswa</h4>
  <p class="text-muted mb-4">Silakan masukkan NISN untuk mengakses formulir.</p>
  
  <div class="mb-3 mx-auto" style="max-width: 320px;">
    <input type="number" id="inputNisnKunci" class="form-control text-center fw-bold p-3 border-primary" placeholder="MASUKKAN NISN SISWA">
    <small id="errorNisn" class="text-danger fw-bold mt-2 d-none">Periksa lagi NISN!</small>
  </div>

  <button id="btnVerifikasi" class="btn btn-primary btn-lg px-5 fw-bold w-100 shadow" onclick="verifikasiAkses()">BUAT FORMULIR BARU</button>
</div>

  <div id="form-section" class="main-card hidden">
    <div class="p-3 bg-light border-bottom text-center"><h6 class="fw-bold mb-0">PENGAJUAN MUTASI KELUAR</h6></div>
    <form id="mutasiForm">
      <div class="section-divider">1. Identitas Siswa</div>
      <div class="form-group"><label>Kelas</label><select id="kelas" class="form-select" onchange="filterSiswa()" required><option value="">-- Pilih Kelas --</option></select></div>
      <div class="form-group"><label>Nama Lengkap</label><select id="nama" class="form-select" onchange="isiData()" required disabled><option value="">-- Pilih Nama --</option></select></div>
      <div class="form-group"><label>NISN</label><input type="text" id="nisn" class="form-control readonly-field" readonly></div>
      <div class="form-group"><label>Jenis Kelamin</label><input type="text" id="jk" class="form-control readonly-field" readonly></div>
      <div class="form-group"><label>Tempat Lahir</label><input type="text" id="tempatLahir" class="form-control readonly-field" readonly></div>
      <div class="form-group"><label>Tanggal Lahir</label><input type="text" id="tanggalLahir" class="form-control readonly-field" readonly></div>

      <div class="section-divider">2. Data Sekolah Tujuan</div>
      <div class="form-group"><label>Nama Sekolah Tujuan</label><input type="text" id="sekolahTujuan" class="form-control" required oninput="validate()"></div>
      <div class="form-group"><label>NPSN</label><input type="text" id="npsn" class="form-control" oninput="validate()"></div>
      <div class="form-group"><label>Alamat Sekolah</label><input type="text" id="alamat" class="form-control" oninput="validate()"></div>
      <div class="form-group"><label>Kelurahan</label><input type="text" id="kel" class="form-control" oninput="validate()"></div>
      <div class="form-group"><label>Kecamatan</label><input type="text" id="kec" class="form-control" oninput="validate()"></div>
      <div class="form-group"><label>Kota/Kabupaten</label><input type="text" id="kota" class="form-control" required oninput="validate()"></div>
      <div class="form-group"><label>Provinsi</label><input type="text" id="prov" class="form-control" required oninput="validate()"></div>

      <div class="section-divider">3. Dokumen & Mutasi</div>
      <div class="form-group"><label>Tanggal Mutasi</label><input type="date" id="tglMutasi" class="form-control" required onchange="validate()"></div>
      <div class="form-group"><label>Upload Surat Rekomendasi (PDF/Gambar)</label><input type="file" id="fileIn" class="form-control" required onchange="validate()"></div>
      <div class="form-group"><div class="bg-light p-3 rounded border mx-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="cek" required onchange="validate()"><label class="form-check-label fw-bold p-0" for="cek">Saya menyatakan data ini benar (Mutasi)</label></div></div></div>

      <button type="submit" id="btn" class="btn btn-primary btn-submit" disabled>KIRIM & PROSES</button>
      <div class="text-center pb-3"><a href="#" onclick="showSection('home')" class="text-muted small text-decoration-none">Batal dan Kembali</a></div>
    </form>
  </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="mb-3">
        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
      </div>
      <h3 class="fw-bold mt-3">Berhasil!</h3>
      <p id="successMsg" class="text-muted mb-4"></p>
      <div class="d-grid shadow-sm">
        <button type="button" class="btn btn-primary fw-bold p-3" onclick="location.reload()">
          SELESAI & TUTUP
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwMqwnB6-Ka5VqoweML_6TYz98rGo6khoGZZIO_Zeo1LdoLl1lyI-2gT6Jdp-lOtvTY/exec";
  let master = [];

  // 1. LOAD DATA (Background)
  window.onload = () => { 
    document.getElementById('loading').style.visibility = 'visible';
    fetch(`${WEB_APP_URL}?action=getSiswa`)
      .then(response => response.json())
      .then(d => {
        master = d; 
        const kS = document.getElementById('kelas');
        [...new Set(d.map(x => x.kelas))].sort().forEach(k => { 
          kS.innerHTML += `<option value="${k}">${k}</option>`; 
        });
        document.getElementById('loading').style.visibility = 'hidden';
      })
      .catch(err => {
        Swal.fire('Error', 'Gagal memuat database siswa!', 'error');
        document.getElementById('loading').style.visibility = 'hidden';
      });
  };

  // 2. VERIFIKASI NISN (Tampilan Keren)
  function verifikasiAkses() {
    const nisnInput = document.getElementById('inputNisnKunci').value;
    const btn = document.getElementById('btnVerifikasi');
    const errMsg = document.getElementById('errorNisn');

    if (!nisnInput) {
      Swal.fire({ icon: 'warning', title: 'Oops...', text: 'Masukkan NISN Anda!', confirmButtonColor: '#1a237e' });
      return;
    }

    const siswa = master.find(x => x.nisn.toString().trim() === nisnInput.toString().trim());

    if (siswa) {
      Swal.fire({
        title: 'Akses Diterima! âœ…',
        html: `Selamat Datang,<br><b style="font-size:1.2rem; color:#1a237e;">${siswa.nama}</b>`,
        icon: 'success',
        timer: 2000,
        showConfirmButton: false,
        timerProgressBar: true,
        didClose: () => {
          showSection('form');
          document.getElementById('kelas').value = siswa.kelas;
          filterSiswa();
          document.getElementById('nama').value = siswa.nama;
          isiData();
        }
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'NISN Tidak Terdaftar',
        text: 'Periksa kembali nomor NISN atau hubungi Admin sekolah.',
        confirmButtonColor: '#d33'
      });
    }
  }

  function showSection(s) { 
    document.getElementById('home-section').classList.toggle('hidden', s !== 'home');
    document.getElementById('form-section').classList.toggle('hidden', s !== 'form');
    window.scrollTo(0,0);
  }

  function filterSiswa() {
    const k = document.getElementById('kelas').value;
    const nS = document.getElementById('nama');
    nS.innerHTML = '<option value="">-- Pilih Nama --</option>'; 
    nS.disabled = !k;
    master.filter(x => x.kelas === k).forEach(s => { 
      nS.innerHTML += `<option value="${s.nama}">${s.nama}</option>`; 
    });
    validate();
  }

  function isiData() {
    const s = master.find(x => x.nama === document.getElementById('nama').value);
    if(s) { 
      ['nisn','jk','tempatLahir','tanggalLahir'].forEach(id => {
        document.getElementById(id).value = s[id] || "";
      });
    }
    validate();
  }

  function validate() {
    const v = (id) => document.getElementById(id).value;
    const isOk = (v('nama') && v('sekolahTujuan') && v('kota') && v('prov') && v('tglMutasi') && document.getElementById('fileIn').files.length > 0 && document.getElementById('cek').checked);
    const btn = document.getElementById('btn');
    btn.disabled = !isOk;
    btn.className = isOk ? "btn btn-success btn-submit shadow" : "btn btn-primary btn-submit";
  }

  // 3. SUBMIT FORM (Notifikasi Keren)
  document.getElementById('mutasiForm').onsubmit = function(e) {
    e.preventDefault();
    const b = document.getElementById('btn'); 
    b.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengirim Data...'; 
    b.disabled = true;
    
    const file = document.getElementById('fileIn').files[0];
    const reader = new FileReader();
    reader.onload = function(r) {
      const payload = {
        obj: {
          kelas: document.getElementById('kelas').value, 
          nama: document.getElementById('nama').value, 
          jk: document.getElementById('jk').value,
          nisn: document.getElementById('nisn').value, 
          tempatLahir: document.getElementById('tempatLahir').value,
          tanggalLahir: document.getElementById('tanggalLahir').value, 
          sekolahTujuan: document.getElementById('sekolahTujuan').value,
          npsn: document.getElementById('npsn').value, 
          alamat: document.getElementById('alamat').value, 
          kelurahan: document.getElementById('kel').value, 
          kecamatan: document.getElementById('kec').value, 
          kota: document.getElementById('kota').value, 
          provinsi: document.getElementById('prov').value,
          tanggalMutasi: document.getElementById('tglMutasi').value
        },
        fileData: {data: r.target.result.split(',')[1], type: file.type}
      };

      fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) })
      .then(res => res.json())
      .then(res => {
        if(res.status === "Sukses") {
          Swal.fire({
            title: 'Berhasil Terkirim! ðŸ“„',
            html: `Data mutasi <b>${res.nama}</b> telah dicatat.<br>Silakan hubungi Admin untuk cetak surat.`,
            icon: 'success',
            confirmButtonText: 'Selesai',
            confirmButtonColor: '#1a237e'
          }).then(() => { location.reload(); });
        } else {
          Swal.fire('Gagal', res.message, 'error');
          b.innerHTML = 'KIRIM & PROSES';
          b.disabled = false;
        }
      })
      .catch(err => {
        Swal.fire('Error', 'Gagal terhubung ke server!', 'error');
        b.innerHTML = 'KIRIM & PROSES';
        b.disabled = false;
      });
    };
    reader.readAsDataURL(file);
  };
</script>
</body>
</html>
